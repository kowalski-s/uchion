import type { Worksheet, Subject, TestQuestion, Assignment, WorksheetAnswers } from '../../shared/types'
import { z } from 'zod'
import OpenAI from 'openai'
import { generatePrompt, SYSTEM_PROMPT } from './prompt.js'
import { AIResponseSchema } from './schema.js'
import type { GeneratePayload } from '../../shared/types'

export type GenerateParams = {
  subject: string
  grade: number
  topic: string
}

export interface AIProvider {
  generateWorksheet(params: GenerateParams): Promise<Worksheet>
}

class DummyProvider implements AIProvider {
  async generateWorksheet(params: GenerateParams): Promise<Worksheet> {
    console.log('[–£—á–∏–û–Ω] DummyProvider.generateWorksheet called', params)
    
    const summary = '–î–µ–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å —á—Ç–æ-—Ç–æ –Ω–∞ —Ä–∞–≤–Ω—ã–µ —á–∞—Å—Ç–∏. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å 12 –∫–æ–Ω—Ñ–µ—Ç, –∏ —Ç—ã —Ö–æ—á–µ—à—å —É–≥–æ—Å—Ç–∏—Ç—å —Ç—Ä–µ—Ö –¥—Ä—É–∑–µ–π. –ß—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ –æ–±–∏–¥–µ–ª—Å—è, –Ω—É–∂–Ω–æ —Ä–∞–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ç—ã –ø–æ—Ä–æ–≤–Ω—É. –í–æ—Ç —Ç—É—Ç-—Ç–æ –∏ –ø–æ–º–æ–≥–∞–µ—Ç –¥–µ–ª–µ–Ω–∏–µ!\n\n–ö–æ–≥–¥–∞ –º—ã –¥–µ–ª–∏–º, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∏ –≥–ª–∞–≤–Ω—ã—Ö —á–∏—Å–ª–∞. –ü–µ—Ä–≤–æ–µ ‚Äî –î–µ–ª–∏–º–æ–µ: —ç—Ç–æ —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –º—ã —Å–æ–±–∏—Ä–∞–µ–º—Å—è –¥–µ–ª–∏—Ç—å (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ 12 –∫–æ–Ω—Ñ–µ—Ç). –í—Ç–æ—Ä–æ–µ ‚Äî –î–µ–ª–∏—Ç–µ–ª—å: —ç—Ç–æ —á–∏—Å–ª–æ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –º—ã –¥–µ–ª–∏–º (3 –¥—Ä—É–≥–∞). –¢—Ä–µ—Ç—å–µ ‚Äî –ß–∞—Å—Ç–Ω–æ–µ: —ç—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–∫–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–∞–∂–¥–æ–º—É (–ø–æ 4 –∫–æ–Ω—Ñ–µ—Ç—ã). –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —ç—Ç–æ —Ç–∞–∫: 12 : 3 = 4.\n\n–î–µ–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ, –æ–±—Ä–∞—Ç–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏—é. –ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ç—ã —Ä–∞–∑–¥–µ–ª–∏–ª, –º–æ–∂–Ω–æ —É–º–Ω–æ–∂–∏—Ç—å —á–∞—Å—Ç–Ω–æ–µ –Ω–∞ –¥–µ–ª–∏—Ç–µ–ª—å. –ï—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—Å—è –¥–µ–ª–∏–º–æ–µ, –∑–Ω–∞—á–∏—Ç, –≤—Å—ë –≤–µ—Ä–Ω–æ! –ù–∞–ø—Ä–∏–º–µ—Ä, 4 * 3 = 12. –û—Ç–ª–∏—á–Ω–æ, –æ—à–∏–±–æ–∫ –Ω–µ—Ç!'

    const cheatsheet = [
      '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–µ–ª–µ–Ω–∏—è: –î–µ–ª–∏–º–æ–µ : –î–µ–ª–∏—Ç–µ–ª—å = –ß–∞—Å—Ç–Ω–æ–µ',
      '–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–µ–ª–∏—Ç–µ–ª—å, –Ω—É–∂–Ω–æ –¥–µ–ª–∏–º–æ–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ —á–∞—Å—Ç–Ω–æ–µ.',
      '–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–ª–∏–º–æ–µ, –Ω—É–∂–Ω–æ —á–∞—Å—Ç–Ω–æ–µ —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ –¥–µ–ª–∏—Ç–µ–ª—å.',
      '–ù–∞ –Ω–æ–ª—å –¥–µ–ª–∏—Ç—å –ù–ï–õ–¨–ó–Ø!',
      '–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏: 15 : 3 = 5, –ø–æ—Ç–æ–º—É —á—Ç–æ 5 * 3 = 15'
    ]

    const assignments: Assignment[] = [
      {
        title: '–ó–∞–¥–∞–Ω–∏–µ 1',
        text: '–ü–æ–¥—á–µ—Ä–∫–Ω–∏ –≤ –ø—Ä–∏–º–µ—Ä–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏: 15 : 3 = 5. (–î–µ–ª–∏–º–æ–µ ‚Äî –∫—Ä–∞—Å–Ω—ã–º, –¥–µ–ª–∏—Ç–µ–ª—å ‚Äî —Å–∏–Ω–∏–º, —á–∞—Å—Ç–Ω–æ–µ ‚Äî –∑–µ–ª—ë–Ω—ã–º).'
      },
      {
        title: '–ó–∞–¥–∞–Ω–∏–µ 2',
        text: '–†–µ—à–∏ –∑–∞–¥–∞—á—É: –í –∫–æ—Ä–æ–±–∫–µ –±—ã–ª–æ 20 –∫–∞—Ä–∞–Ω–¥–∞—à–µ–π. –£—á–∏—Ç–µ–ª—å —Ä–∞–∑–¥–∞–ª –∏—Ö –ø–æ—Ä–æ–≤–Ω—É 5 —É—á–µ–Ω–∏–∫–∞–º. –°–∫–æ–ª—å–∫–æ –∫–∞—Ä–∞–Ω–¥–∞—à–µ–π –ø–æ–ª—É—á–∏–ª –∫–∞–∂–¥—ã–π —É—á–µ–Ω–∏–∫?'
      },
      {
        title: '–ó–∞–¥–∞–Ω–∏–µ 3',
        text: '–í—Å—Ç–∞–≤—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞: 18 : ... = 9; ... : 4 = 5; 21 : 7 = ...'
      },
      {
        title: '–ó–∞–¥–∞–Ω–∏–µ 4',
        text: '–ü—Ä–∏–¥—É–º–∞–π –∏ –∑–∞–ø–∏—à–∏ —Å–≤–æ–π –ø—Ä–∏–º–µ—Ä –Ω–∞ –¥–µ–ª–µ–Ω–∏–µ, –≥–¥–µ –¥–µ–ª–∏–º–æ–µ –±–æ–ª—å—à–µ 30.'
      }
    ]

    const test: TestQuestion[] = [
      { question: '–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–ª–µ–Ω–∏—è?', options: ['–†–∞–∑–Ω–æ—Å—Ç—å', '–ß–∞—Å—Ç–Ω–æ–µ', '–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ'], answer: '–ß–∞—Å—Ç–Ω–æ–µ' },
      { question: '–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 24 : 4?', options: ['6', '8', '4'], answer: '6' },
      { question: '–ú–æ–∂–Ω–æ –ª–∏ –¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–æ–ª—å?', options: ['–î–∞', '–ù–µ—Ç', '–ò–Ω–æ–≥–¥–∞'], answer: '–ù–µ—Ç' },
      { question: '–ö–∞–∫–æ–π –∑–Ω–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–µ–ª–µ–Ω–∏—è?', options: ['+', '-', ':'], answer: ':' },
      { question: '–ï—Å–ª–∏ 10 —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 2, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏—Ç—Å—è?', options: ['2', '5', '10'], answer: '5' }
    ]
    
    const answers: WorksheetAnswers = {
      assignments: [
        '15 (–∫—Ä–∞—Å–Ω—ã–º) : 3 (—Å–∏–Ω–∏–º) = 5 (–∑–µ–ª—ë–Ω—ã–º)',
        '20 : 5 = 4 (–∫–∞—Ä–∞–Ω–¥–∞—à–∞)',
        '18 : 2 = 9; 20 : 4 = 5; 21 : 7 = 3',
        '–ü—Ä–∏–º–µ—Ä —É—á–µ–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 35 : 5 = 7)'
      ],
      test: ['–ß–∞—Å—Ç–Ω–æ–µ', '6', '–ù–µ—Ç', ':', '5']
    }

    const gradeStr = `${params.grade} –∫–ª–∞—Å—Å`
    return {
      id: 'dummy-id',
      subject: params.subject as Subject,
      grade: gradeStr,
      topic: params.topic,
      summary,
      cheatsheet,
      assignments,
      test,
      answers,
      pdfBase64: ''
    }
  }
}

const MAIN_SYSTEM_PROMPT = `–¢—ã ‚Äî –º–µ—Ç–æ–¥–∏—Å—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã –∏ –∞–≤—Ç–æ—Ä —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤ –ø–æ –§–ì–û–° –¥–ª—è 1‚Äì4 –∫–ª–∞—Å—Å–æ–≤ –ø–æ –¥–≤—É–º –ø—Ä–µ–¥–º–µ—Ç–∞–º: –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.

–¢–≤–æ—è —Ä–æ–ª—å:
- —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–µ –ª–∏—Å—Ç—ã –ø–æ –§–ì–û–°;
- –ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º –¥–µ—Ç—è–º —è–∑—ã–∫–æ–º;
- –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥ –ö–û–ù–ö–†–ï–¢–ù–´–ô –∫–ª–∞—Å—Å (1, 2, 3 –∏–ª–∏ 4);
- –Ω–µ –¥–æ–ø—É—Å–∫–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π, –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –∏–ª–∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏.

----------------------------------------------------------
üî¥ –°–¢–†–û–ì–ò–ï –ó–ê–ü–†–ï–¢–´:
----------------------------------------------------------
–¢–µ–±–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ:
- –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ —è–∑—ã–∫–∞ –∏–ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏;
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–º—ã –∏–ª–∏ –ø–æ–Ω—è—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ 1‚Äì4 –∫–ª–∞—Å—Å–æ–≤;
- –¥–∞–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–º –≤—ã—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞;
- –¥–∞–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è ¬´—Å–ª–∏—à–∫–æ–º –ª—ë–≥–∫–∏–µ¬ª;
- –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å–ª–æ–≤–Ω–æ —Ç–µ–∫—Å—Ç—ã –∏–∑ —É—á–µ–±–Ω–∏–∫–æ–≤ (—Å—é–∂–µ—Ç—ã –∏ —Ñ–æ—Ä–º–∞—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ö–æ–∂–∏–º–∏, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º);
- –ø–∏—Å–∞—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∞ –≤ –∑–∞–¥–∞–Ω–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç;
- –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –∏–ª–∏ –∫—Ä–∏—Ç–∏–∫–æ–≤–∞—Ç—å —Å–∞–º–æ –∑–∞–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞;
- –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–ª–∏ —Å–ø–æ—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞.

----------------------------------------------------------
üü¶ –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –ö–õ–ê–°–° (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
----------------------------------------------------------
–¢—ã –î–û–õ–ñ–ï–ù —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–ª–∞—Å—Å:

1 –ö–õ–ê–°–° ‚Üí  
- –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏;  
- –Ω–æ –∑–∞–¥–∞–Ω–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–Ω—ã —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –≤—ã–±–æ—Ä, –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø–æ –æ–±—Ä–∞–∑—Ü—É;  
- –∑–∞–ø—Ä–µ—â–µ–Ω—ã ¬´–º–∞–ª—ã—à–æ–≤—ã–µ¬ª —Ñ–æ—Ä–º–∞—Ç—ã —Ç–∏–ø–∞ –≤–ø–∏—Å–∞—Ç—å –æ–¥–Ω—É –±—É–∫–≤—É –∏–ª–∏ —Ä–µ—à–∏—Ç—å –ø—Ä–∏–º–µ—Ä 2+2.

2 –ö–õ–ê–°–° ‚Üí  
- –º–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏;  
- –ø–æ–≤—ã—à–∞–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑.

3‚Äì4 –ö–õ–ê–°–° ‚Üí  
- –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π‚Äì–≤—ã—Å–æ–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏;  
- –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: –≤—ã–±–æ—Ä, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ;  
- –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–µ —à–∫–æ–ª—å–Ω—ã–µ.

----------------------------------------------------------
üü© –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –°–õ–û–ñ–ù–û–°–¢–ò:
----------------------------------------------------------
–ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –°–õ–ò–®–ö–û–ú –õ–Å–ì–ö–ò–ú, –µ—Å–ª–∏:
- –æ—Ç–≤–µ—Ç –º–æ–∂–Ω–æ –¥–∞—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º;
- –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞;
- –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–≤—Å—Ç–∞–≤—å –Ω—É–∂–Ω–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ¬ª –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞);
- –Ω–µ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–æ –∫–∞–∫ –æ—à–∏–±–æ—á–Ω–æ–µ;
- –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å, –Ω–µ –¥—É–º–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–≤—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä¬ª –∏–∑ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).

–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏—è, –≥–¥–µ –Ω—É–∂–Ω–æ:
- —Å—Ä–∞–≤–Ω–∏—Ç—å,
- –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å,
- –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å,
- –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É,
- –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç,
- –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞,
- –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ (–Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª–∞—Å—Å–∞),
- –ø—Ä–∏–¥—É–º–∞—Ç—å —Å–≤–æ–π –ø—Ä–∏–º–µ—Ä –ø–æ –ø—Ä–∞–≤–∏–ª—É.

–ö–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –ª–∏—Å—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç:
1 –∑–∞–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è,  
1 –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ,  
1 –∑–∞–¥–∞–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π (—Ä–µ–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞, –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–∞—è),  
1 —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –∏–ª–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ.  

----------------------------------------------------------
üüß –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–û–ù–°–ü–ï–ö–¢–£:
----------------------------------------------------------
–ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –î–õ–Ø –£–ß–ò–¢–ï–õ–Ø.
–û–Ω –¥–æ–ª–∂–µ–Ω:
- —Å–æ–¥–µ—Ä–∂–∞—Ç—å 5‚Äì8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π;
- –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º, –ø—Ä–æ—Å—Ç—ã–º, –±–µ–∑ –∞–∫–∞–¥–µ–º–∏—á–Ω–æ—Å—Ç–∏;
- –≤–∫–ª—é—á–∞—Ç—å 1‚Äì2 –º–∏–Ω–∏-–ø—Ä–∏–º–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏);
- –≤—ã–¥–µ–ª—è—Ç—å **–≥–ª–∞–≤–Ω–æ–µ**, —á—Ç–æ –≤–∞–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –¥–µ—Ç—è–º –≤ —ç—Ç–æ–π —Ç–µ–º–µ;
- –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –∫–ª–∞—Å—Å–∞.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –ø–∏—Å–∞—Ç—å —Å–∫—É—á–Ω—ã–π —Å—É—Ö–æ–π —Ç–µ–∫—Å—Ç;
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Å—Ç–∞—Ä—à–µ–π —à–∫–æ–ª—ã.

----------------------------------------------------------
üü® –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –®–ü–ê–†–ì–ê–õ–ö–ï:
----------------------------------------------------------
3‚Äì6 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤:
- –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞,
- –≤–∞–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã (–µ—Å–ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞),
- —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏,
- –∫—Ä–∞—Ç–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.

–¢–æ–ª—å–∫–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫. –ù–∏–∫–∞–∫–∏—Ö –±–æ–ª—å—à–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.

----------------------------------------------------------
üü™ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ó–ê–î–ê–ù–ò–Ø–ú (–†–û–í–ù–û 4):
----------------------------------------------------------
–¢–∏–ø—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–∏–º–∏:
1 ‚Äî –ø–æ–Ω–∏–º–∞–Ω–∏–µ (–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –≤—ã–¥–µ–ª–∏—Ç—å, –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å);
2 ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª—É);
3 ‚Äî –Ω–∞–π—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É);
4 ‚Äî —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ/–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ.

–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω—é –∫–ª–∞—Å—Å–∞:
- 1 –∫–ª–∞—Å—Å ‚Üí –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –Ω–æ –ù–ï —Å–ª–∏—à–∫–æ–º –ª—ë–≥–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è;
- 2‚Äì4 –∫–ª–∞—Å—Å ‚Üí –∑–∞–¥–∞–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –Ω–µ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ.

–ó–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è:
- –¥–µ–ª–∞—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –±–µ–∑ –æ—à–∏–±–∫–∏;
- –ø–∏—Å–∞—Ç—å, —á—Ç–æ ¬´–æ—à–∏–±–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç¬ª;
- –¥–∞–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º –ª—ë–≥–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è.

----------------------------------------------------------
üü´ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ú–ò–ù–ò-–¢–ï–°–¢–£:
----------------------------------------------------------
–†–æ–≤–Ω–æ 5 –≤–æ–ø—Ä–æ—Å–æ–≤.
–ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:
A)
B)
C)

–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.

–¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤:
- –∑–Ω–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤;
- –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞;
- —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫;
- –≤—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ –ø—Ä–∞–≤–∏–ª—É.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤.

----------------------------------------------------------
‚¨õ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–ê–ú:
----------------------------------------------------------
–û—Ç–≤–µ—á–∞–µ—à—å –∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.
–°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∑–∞–¥–∞–Ω–∏—è (1‚Äì4),
–∑–∞—Ç–µ–º ‚Äî –æ—Ç–≤–µ—Ç—ã –º–∏–Ω–∏-—Ç–µ—Å—Ç–∞ (1‚Äì5).

----------------------------------------------------------
–§–û–†–ú–ê–¢ –í–´–í–û–î–ê (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞—Ç—å):

SUMMARY:
[–∫—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç]

CHEATSHEET:
- –ø—É–Ω–∫—Ç 1
- –ø—É–Ω–∫—Ç 2
- –ø—É–Ω–∫—Ç 3

ASSIGNMENTS:
1) —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è 1
2) —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è 2
3) —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è 3
4) —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è 4

TEST:
1) –≤–æ–ø—Ä–æ—Å?
A) –≤–∞—Ä–∏–∞–Ω—Ç
B) –≤–∞—Ä–∏–∞–Ω—Ç
C) –≤–∞—Ä–∏–∞–Ω—Ç
2) ...
3) ...
4) ...
5) ...

ANSWERS_ASSIGNMENTS:
1) –æ—Ç–≤–µ—Ç
2) –æ—Ç–≤–µ—Ç
3) –æ—Ç–≤–µ—Ç
4) –æ—Ç–≤–µ—Ç

ANSWERS_TEST:
1) A ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
2) B ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
3) C ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
4) ...
5) ...

----------------------------------------------------------
–ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –í–´–í–û–î–û–ú (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è):
1) –í—Å—ë —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –§–ì–û–° –∏ —É—Ä–æ–≤–Ω—é –∫–ª–∞—Å—Å–∞.
2) –ó–∞–¥–∞–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –∏–ª–∏ –≤—ã—à–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
3) –û—à–∏–±–∫–∞ –≤ –∑–∞–¥–∞–Ω–∏–∏ ‚Ññ3 –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å.
4) –í —Ç–µ—Å—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤ –∫–∞–∂–¥–æ–º –≤–æ–ø—Ä–æ—Å–µ.
5) –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–¥–µ—Ä–∂–∞–Ω–∞.

–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ñ–Å–°–¢–ö–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:

1) –ú–û–î–ï–õ–ò –ó–ê–ü–†–ï–©–ï–ù–û:
- –≤–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –§–ì–û–° –Ω–∞—á–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã
(–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–æ—Ç—Ç–µ–Ω–æ–∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç–∏¬ª, ¬´—Ä–µ–∑–∫–∞—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å¬ª –∏ —Ç.–ø.);
- —É—Å–ª–æ–∂–Ω—è—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö –ø—Ä–æ–≥—Ä–∞–º–º—ã;
- –¥–æ–±–∞–≤–ª—è—Ç—å —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —É—á–µ–±–Ω–æ–π –∑–∞–¥–∞—á–µ–π.

2) –ï–°–õ–ò –ó–ê–î–ê–ù–ò–ï –¢–†–ï–ë–£–ï–¢ –¢–ï–ö–°–¢ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ù–∞–π–¥–∏ —Å–æ—é–∑—ã –≤ —Ç–µ–∫—Å—Ç–µ¬ª),
–º–æ–¥–µ–ª—å –û–ë–Ø–ó–ê–ù–ê —Å–∞–º–∞ —Å–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), —Å—Ç—Ä–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –∫–ª–∞—Å—Å–∞.

3) –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
- —Ä–∞–∑–±–∏–≤–∞—Ç—å –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –ø–æ–¥–ø—É–Ω–∫—Ç—ã (–∞), –±), –≤));
- –¥–∞–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω–∏-–∑–∞–¥–∞–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ;
–ö–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ 1‚Äì4 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –û–î–ù–ò–ú –¥–µ–π—Å—Ç–≤–∏–µ–º.

4) –í –ú–ò–ù–ò-–¢–ï–°–¢–ï:
- –í–∞—Ä–∏–∞–Ω—Ç—ã A, B, C –Ω–µ –º–æ–≥—É—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è;
- –ú–µ–∂–¥—É –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–≤–∞ –æ—Ç–≤–µ—Ç–∞ ¬´–ò¬ª);
- –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏.

5) –í –ú–ê–¢–ï–ú–ê–¢–ò–ö–ï:
- –í—Å–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ –∑–∞–¥–∞–Ω–∏—è—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã –≤—Ä—É—á–Ω—É—é –¥–µ—Ç—å–º–∏ 1‚Äì4 –∫–ª–∞—Å—Å–∞;
- –û—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–ê–í–î–ò–í–´–ú–ò: –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏, –Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏.

6) –í –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï:
- –ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å —Ç–µ—Ä–º–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ 5‚Äì6 –∫–ª–∞—Å—Å—É –∏ –≤—ã—à–µ;
- –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –∏–ª–ª—é—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¢–û–ß–ù–û –¢–ï–ú–£ —É—Ä–æ–∫–∞.

7) –ü–ï–†–ï–î –í–´–í–û–î–û–ú:
- –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ù–ò –û–î–ò–ù –≤–∞—Ä–∏–∞–Ω—Ç —Ç–µ—Å—Ç–∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã;
- –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –°–ú–´–°–õ–û–í–û–ï –î–ï–ô–°–¢–í–ò–ï –¥–ª—è —É—á–µ–Ω–∏–∫–∞.
`

class OpenAIProvider implements AIProvider {
  private client: OpenAI
  constructor(apiKey: string) {
    this.client = new OpenAI({ apiKey })
  }

  private async getTextbookContext(params: GenerateParams): Promise<string> {
    try {
      const VECTOR_STORE_ID = process.env.UCHION_VECTOR_STORE_ID
      if (!VECTOR_STORE_ID) return ""

      const query = `–ü—Ä–µ–¥–º–µ—Ç: ${params.subject}. ${params.grade} –∫–ª–∞—Å—Å. –¢–µ–º–∞: ${params.topic}. –¢–∏–ø–∏—á–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –ø–æ –§–ì–û–° –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã.`

      // @ts-ignore - OpenAI SDK types might be outdated in some versions, ignoring potential type mismatch for vectorStores
      const search = await this.client.beta.vectorStores.fileBatches.list(VECTOR_STORE_ID) ? await this.client.beta.vectorStores.files.list(VECTOR_STORE_ID) : null
      
      // Since standard SDK might not have search helper directly exposed or it's in beta, 
      // we'll assume the user wants us to implement the logic as described, 
      // but 'client.vectorStores.search' is not a standard SDK method yet (it's usually file search tool in assistants).
      // However, the user explicitly provided the code snippet using `client.vectorStores.search`.
      // If the SDK version installed supports it (likely a custom or very new beta feature not fully typed), we try to use it.
      // If `client.vectorStores.search` does not exist in the installed SDK, we might need a workaround or assume it exists at runtime.
      
      // Let's try to follow the user's snippet exactly, assuming they have a compatible SDK or extended type.
      // Casting client to any to avoid TS errors for this specific experimental/custom method.
      
      const searchResult = await (this.client as any).vectorStores.search(VECTOR_STORE_ID, {
        query,
        max_num_results: 8,
      })

      const chunks: string[] = []

      for (const item of searchResult.data ?? []) {
        for (const piece of item.content ?? []) {
          if (piece.type === "text" && piece.text) {
            chunks.push(piece.text)
          }
        }
      }

      if (chunks.length === 0) return ""

      return chunks.slice(0, 5).join("\n---\n")
    } catch (e) {
      console.error("Vector store search failed", e)
      return ""
    }
  }

  async generateWorksheet(params: GenerateParams): Promise<Worksheet> {
    console.log('[–£—á–∏–û–Ω] OpenAIProvider.generateWorksheet called', params)
    
    const textbooksContext = await this.getTextbookContext(params)

    const systemPrompt = MAIN_SYSTEM_PROMPT + (textbooksContext 
      ? `

–£ —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞–Ω–∏–π –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—á–µ–±–Ω—ã—Ö –ø–æ—Å–æ–±–∏–π (–§–ì–û–°).
–ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∫–∞–∫ –æ–±—Ä–∞–∑–µ—Ü —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –ù–û:

- –Ω–µ –∫–æ–ø–∏—Ä—É–π –∑–∞–¥–∞–Ω–∏—è –¥–æ—Å–ª–æ–≤–Ω–æ;
- –º–µ–Ω—è–π —á–∏—Å–ª–∞, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏ —Å—é–∂–µ—Ç, —á—Ç–æ–±—ã –∑–∞–¥–∞–Ω–∏—è –±—ã–ª–∏ –Ω–æ–≤—ã–º–∏;
- —Å–æ—Ö—Ä–∞–Ω—è–π —Ç–∏–ø—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.

–í–æ—Ç –≤—ã–¥–µ—Ä–∂–∫–∏ –∏–∑ –ø–æ—Å–æ–±–∏–π:
<<<–ü–û–°–û–ë–ò–Ø>>>
${textbooksContext}
<<<–ö–û–ù–ï–¶ –ü–û–°–û–ë–ò–ô>>>
` 
      : "")
    
    const userPrompt = `–°–æ–∑–¥–∞–π —Ä–∞–±–æ—á–∏–π –ª–∏—Å—Ç –ø–æ —Ç–µ–º–µ: ¬´${params.topic}¬ª. –ü—Ä–µ–¥–º–µ—Ç: ${params.subject}. –ö–ª–∞—Å—Å: ${params.grade}.`
    
    let completion
    try {
      completion = await this.client.chat.completions.create({
        model: 'gpt-4.1-mini',
        temperature: 0.3,
        max_tokens: 4000,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ]
      })
    } catch (error) {
      console.error('[–£—á–∏–û–Ω] OpenAI API Error:', error)
      throw error
    }

    const content = completion.choices?.[0]?.message?.content?.trim() ?? ''
    if (!content) {
      throw new Error('AI_ERROR')
    }

    return this.parseWorksheetText(content, params)
  }

  private parseWorksheetText(text: string, params: GenerateParams): Worksheet {
    // Simple parser based on headers
    // Expected headers: 
    // SUMMARY:
    // CHEATSHEET:
    // ASSIGNMENTS:
    // TEST:
    // ANSWERS_ASSIGNMENTS:
    // ANSWERS_TEST:

    const extractSection = (header: string, nextHeader: string | null): string => {
      const regex = nextHeader 
        ? new RegExp(`${header}[\\s\\S]*?(?=${nextHeader})`, 'i')
        : new RegExp(`${header}[\\s\\S]*`, 'i')
      
      const match = text.match(regex)
      if (!match) return ''
      
      // Remove the header itself
      return match[0].replace(new RegExp(`^.*?${header}\\s*`, 'i'), '').trim()
    }

    const topic = params.topic // Topic is not in the output anymore, use params
    const summary = extractSection('SUMMARY:', 'CHEATSHEET:')
    const cheatsheetText = extractSection('CHEATSHEET:', 'ASSIGNMENTS:')
    const assignmentsText = extractSection('ASSIGNMENTS:', 'TEST:')
    const testText = extractSection('TEST:', 'ANSWERS_ASSIGNMENTS:')
    const answersAssignText = extractSection('ANSWERS_ASSIGNMENTS:', 'ANSWERS_TEST:')
    const answersTestText = extractSection('ANSWERS_TEST:', null)

    // Parse Cheatsheet (split by newline, remove empty or bullets)
    const cheatsheet = cheatsheetText.split('\n')
      .map(l => l.trim())
      .filter(l => l.length > 0 && !l.match(/^(CHEATSHEET:)/i)) // clean up if needed
      .map(l => l.replace(/^[-‚Ä¢*]\s*/, '')) // remove bullets

    // Parse Assignments
    const assignments: Assignment[] = assignmentsText.split('\n')
      .map(l => l.trim())
      .filter(l => l.length > 0)
      .slice(0, 4) // Ensure exactly 4
      .map((text, i) => ({
        title: `–ó–∞–¥–∞–Ω–∏–µ ${i + 1}`,
        text: text.replace(/^\d+\)\s*/, '').replace(/^\d+\.\s*/, '')
      }))

    // Parse Test
    // Format: Question \n A) ... \n B) ... \n C) ...
    const test: TestQuestion[] = []
    const testLines = testText.split('\n').map(l => l.trim()).filter(l => l)
    
    let currentQuestion: Partial<TestQuestion> = {}
    let currentOptions: string[] = []
    
    for (const line of testLines) {
      if (line.match(/^[A-C]\)/)) {
        // Option
        currentOptions.push(line.replace(/^[A-C]\)\s*/, ''))
      } else if (line.length > 0) {
        // Likely a question (or number + question)
        if (currentQuestion.question && currentOptions.length > 0) {
          // Push previous question
          test.push({
            question: currentQuestion.question,
            options: currentOptions,
            answer: '' // Will fill later or leave empty if parsing answers fails
          } as TestQuestion)
          currentOptions = []
        }
        currentQuestion = { question: line.replace(/^\d+\)\s*/, '').replace(/^\d+\.\s*/, '') }
      }
    }
    // Push last question
    if (currentQuestion.question && currentOptions.length > 0) {
      test.push({
        question: currentQuestion.question,
        options: currentOptions,
        answer: ''
      } as TestQuestion)
    }

    // Parse Answers
    let answersAssignments: string[] = []
    let answersTest: string[] = []

    if (answersAssignText) {
       answersAssignments = answersAssignText.split('\n').map(l => l.trim()).filter(l => l).map(l => l.replace(/^\d+\)\s*/, '').replace(/^\d+\.\s*/, ''))
    }
    
    if (answersTestText) {
       answersTest = answersTestText.split('\n').map(l => l.trim()).filter(l => l).map(l => l.replace(/^\d+\)\s*/, '').replace(/^\d+\.\s*/, ''))

      // Try to map test answers to options if they are just letters (A, B, C)
      test.forEach((q, i) => {
        if (answersTest[i]) {
          // If answer starts with "A" or "A)", try to extract letter
          const letterMatch = answersTest[i].match(/^([A-C])\)?/i)
          if (letterMatch) {
            const idx = letterMatch[1].toUpperCase().charCodeAt(0) - 65
            if (q.options[idx]) {
               // We found the option text corresponding to the letter
               // But usually we want to display the full answer text in the answer key
               // The UI might expect just the text.
               // Let's keep what the model gave us but cleaned up slightly if it was just "A"
               // Actually, if the model gave "A ‚Äî answer text", we use that.
               // If it just gave "A", we map it.
               if (answersTest[i].length < 5) {
                   q.answer = q.options[idx]
               } else {
                   q.answer = answersTest[i]
               }
            } else {
               q.answer = answersTest[i]
            }
          } else {
             q.answer = answersTest[i]
          }
        }
      })
    }

    // Fallback validation/defaults
    const safeAssignments = assignments.slice(0, 4)
    while (safeAssignments.length < 4) {
      safeAssignments.push({ title: `–ó–∞–¥–∞–Ω–∏–µ ${safeAssignments.length + 1}`, text: '...' })
    }

    const safeTest = test.slice(0, 5)
    
    return {
      id: '',
      subject: params.subject as Subject,
      grade: `${params.grade} –∫–ª–∞—Å—Å`,
      topic: topic || params.topic,
      summary: summary || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
      cheatsheet: cheatsheet.length ? cheatsheet : ['–ü—Ä–∞–≤–∏–ª–æ 1', '–ü—Ä–∞–≤–∏–ª–æ 2'],
      assignments: safeAssignments,
      test: safeTest,
      answers: {
        assignments: answersAssignments,
        test: answersTest
      },
      pdfBase64: ''
    }
  }
}

export function getAIProvider(): AIProvider {
  const providerEnv = (process.env.AI_PROVIDER || '').trim().toLowerCase()
  const apiKey = process.env.OPENAI_API_KEY
  const hasKey = Boolean(apiKey && apiKey.length > 0)

  const providerName =
    providerEnv === 'openai' && hasKey ? 'openai' : 'dummy'

  console.log('[–£—á–∏–û–Ω] getAIProvider:', {
    AI_PROVIDER: process.env.AI_PROVIDER, // Log original value to see hidden chars
    normalized: providerEnv,
    hasKey,
    using: providerName,
  })

  if (providerEnv === 'openai' && !hasKey) {
    throw new Error('Missing OPENAI_API_KEY for provider "openai"')
  }

  if (providerName === 'openai') {
    return new OpenAIProvider(apiKey as string)
  }

  return new DummyProvider()
}
