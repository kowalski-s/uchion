# Architecture Overview

## 1. Общая концепция
Uchion — это веб-сервис для генерации рабочих листов (Worksheets) для начальной школы (1–4 классы) с использованием искусственного интеллекта. Проект реализует полный цикл: от ввода темы учителем до генерации PDF-файла, готового к печати.

## 2. Архитектура Системы

Система построена как **Monorepo** с чётким разделением ответственности:

### 2.1 Клиентская часть (Frontend)
- **Технологии**: React, Vite, TypeScript, Tailwind CSS.
- **Роутинг**: SPA (Single Page Application) с использованием React Router.
  - `/` — Страница генерации (`GeneratePage`).
  - `/worksheet/:sessionId` — Страница просмотра и скачивания (`WorksheetPage`).
- **Состояние**: Zustand (хранение сессий и кэширование).
- **Взаимодействие с API**: `fetch` + Server-Sent Events (SSE) для стриминга прогресса.

### 2.2 Серверная часть (Backend)
- **Технологии**: Vercel Serverless Functions (Node.js).
- **API**: Единый endpoint `/api/generate`.
- **Роль**:
  - Валидация входных данных (Zod).
  - Оркестрация AI-генерации.
  - Валидация и регенерация контента.
  - Генерация PDF.

### 2.3 Shared Layer (Общий слой)
- **Путь**: `shared/worksheet.ts`
- **Роль**: Единый источник правды для типов и схем данных. Используется и клиентом, и сервером для гарантии контракта.

---

## 3. Поток Данных (Data Flow)

1.  **Запрос**: Пользователь заполняет форму (Предмет, Класс, Тема) → Клиент отправляет `POST /api/generate`.
2.  **Генерация (Server)**:
    *   API вызывает `AIProvider`.
    *   `AIProvider` выбирает стратегию (OpenAI для Prod, Dummy для Dev).
    *   Генерируется черновик JSON через LLM.
3.  **Валидация и Регенерация**:
    *   Черновик проходит через `Validator` (LLM-based проверка качества).
    *   Если найдены ошибки, запускается частичная регенерация проблемных блоков.
    *   Процесс повторяется до успеха или исчерпания попыток.
4.  **Сборка**:
    *   Финальный JSON конвертируется в объект `Worksheet`.
    *   Генерируется PDF (Base64) на сервере.
5.  **Ответ**: Сервер стримит события (Progress → Result) через SSE клиенту.
6.  **Рендер**: Клиент отображает лист и предлагает скачать PDF.

---

## 4. Ключевые Модули

### AI Provider (`api/_lib/ai-provider.ts`)
Абстракция над LLM.
- **DummyProvider**: Локальная заглушка для разработки (не тратит деньги, работает оффлайн).
- **OpenAIProvider**: Продакшн-решение. Использует Context Retrieval (Vector Store) и GPT-4o-mini.

### Validator (`api/_lib/ai/validator.ts`)
Модуль контроля качества.
- Анализирует структуру и содержание.
- Выявляет логические ошибки (например, неверный ответ в тесте).
- Управляет циклом самоисправления (Self-Correction).

### PDF Generator
Двухуровневая генерация:
- **Server (`api/_lib/pdf.ts`)**: Использует `pdfkit`. Создаёт финальный файл для скачивания.
- **Client (`src/lib/pdf-client.ts`)**: Использует `pdf-lib`. Создаёт превью "на лету" (опционально) или дублирует серверную логику для надежности.

---

## 5. Инфраструктура

- **Хостинг**: Vercel.
- **CI/CD**: Автоматические деплои при пуше в main.
- **Environment**:
  - `dev`: Vite Proxy (`/api` → `localhost:3000`), Dummy AI.
  - `prod`: Vercel Functions, OpenAI.
