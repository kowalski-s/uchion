# –°–∏—Å—Ç–µ–º–∞ Telegram-–∞–ª–µ—Ä—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –≤ Telegram –ø—Ä–∏ —Å–±–æ—è—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å AI –∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
server/routes/generate.ts          -- –≤—ã–∑—ã–≤–∞–µ—Ç trackGeneration() –∏ sendInstantFailureAlert()
api/_lib/providers/openai-provider.ts -- –≤—ã–∑—ã–≤–∞–µ—Ç checkValidationScore()
api/_lib/alerts/generation-alerts.ts -- –ª–æ–≥–∏–∫–∞ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
api/_lib/telegram/bot.ts           -- sendAdminAlert() -> Telegram Bot API
api/_lib/telegram/commands.ts      -- –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (/subscribe, /status)
server/routes/admin/settings.ts    -- API –ø—Ä–∏–≤—è–∑–∫–∏ Chat ID —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
server/routes/admin/alerts.ts      -- —Ç–µ—Å—Ç–æ–≤—ã–µ/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
server.ts                          -- –∞–ª–µ—Ä—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
```

## –ü—Ä–∏–≤—è–∑–∫–∞ Telegram –∫ –∞–∫–∫–∞—É–Ω—Ç—É –∞–¥–º–∏–Ω–∞

–î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Chat ID:

1. **–ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É** (–æ—Å–Ω–æ–≤–Ω–æ–π) -- —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/admin/settings`, –≤–≤–æ–¥ Chat ID –≤—Ä—É—á–Ω—É—é. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ `telegramChatId` —Ç–∞–±–ª–∏—Ü—ã `users`.
2. **–ß–µ—Ä–µ–∑ –±–æ—Ç–∞** (legacy) -- –∫–æ–º–∞–Ω–¥–∞ `/subscribe`. –†–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏–ª —á–µ—Ä–µ–∑ Telegram OAuth (`provider='telegram'`) –∏–ª–∏ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–ª Chat ID —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É.

–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Chat ID: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` –±–æ—Ç—É [@userinfobot](https://t.me/userinfobot).

### –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ

–§—É–Ω–∫—Ü–∏—è `findUserByTelegramId()` –∏—â–µ—Ç –≤ –¥–≤–∞ —ç—Ç–∞–ø–∞:
1. `provider='telegram' AND providerId=<telegramId>` (legacy OAuth)
2. `telegramChatId=<telegramId>` (–ø—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É)

## –ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–ª–µ—Ä—Ç—ã

`sendAdminAlert()` –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∑–∞–ø—Ä–æ—Å–æ–º:

```sql
SELECT * FROM users
WHERE role = 'admin'
  AND wants_alerts = true
  AND telegram_chat_id IS NOT NULL
```

–ê–ª–µ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–≤—Å–µ–º** –ø–æ–¥—Ö–æ–¥—è—â–∏–º –∞–¥–º–∏–Ω–∞–º, –Ω–µ –æ–¥–Ω–æ–º—É.

## –¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤

### 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| –§—É–Ω–∫—Ü–∏—è | `sendInstantFailureAlert()` |
| –£—Ä–æ–≤–µ–Ω—å | `critical` |
| Cooldown | –ù–µ—Ç (–∫–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–ª) |
| –¢—Ä–∏–≥–≥–µ—Ä | catch-–±–ª–æ–∫ –≤ `POST /api/generate` |

–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–ª–Ω–æ–º –ø—Ä–æ–≤–∞–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: AI-–æ—à–∏–±–∫–∞ –∏–ª–∏ PDF-–æ—à–∏–±–∫–∞. –°–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–µ–¥–º–µ—Ç, –∫–ª–∞—Å—Å, —Ç–µ–º—É, email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏.

### 2. –í—ã—Å–æ–∫–∏–π error rate

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| –§—É–Ω–∫—Ü–∏—è | `trackGeneration(false)` -> `checkErrorRateAndAlert()` |
| –£—Ä–æ–≤–µ–Ω—å | `critical` |
| Cooldown | 30 –º–∏–Ω—É—Ç |
| –ü–æ—Ä–æ–≥ | >10% –æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å |
| –ú–∏–Ω. –¥–∞–Ω–Ω—ã—Ö | 5 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –æ–∫–Ω–µ |

–•—Ä–∞–Ω–∏—Ç in-memory –º–∞—Å—Å–∏–≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 1000 –∑–∞–ø–∏—Å–µ–π `{timestamp, success}`. –ó–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è. –ü—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–µ—É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –≤ —Å–∫–æ–ª—å–∑—è—â–µ–º –æ–∫–Ω–µ.

–ü—Ä–∏–º–µ—Ä: 20 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∑–∞ —á–∞—Å, 3 –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å = 15% > 10% -> –∞–ª–µ—Ä—Ç.

### 3. AI —Ç–∞–π–º–∞—É—Ç—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| –§—É–Ω–∫—Ü–∏—è | `trackAICall({ isTimeout: true })` |
| –£—Ä–æ–≤–µ–Ω—å | `critical` |
| Cooldown | 30 –º–∏–Ω—É—Ç |
| –ü–æ—Ä–æ–≥ | 3 —Ç–∞–π–º–∞—É—Ç–∞ –ø–æ–¥—Ä—è–¥ |

–°—á—ë—Ç—á–∏–∫ consecutive —Ç–∞–π–º–∞—É—Ç–æ–≤. –õ—é–±–æ–π —É—Å–ø–µ—à–Ω—ã–π AI-–≤—ã–∑–æ–≤ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –≤ 0.

### 4. –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| –§—É–Ω–∫—Ü–∏—è | `checkValidationScore()` |
| –£—Ä–æ–≤–µ–Ω—å | `warning` |
| Cooldown | –ù–µ—Ç (–∫–∞–∂–¥—ã–π —Ä–∞–∑) |
| –ü–æ—Ä–æ–≥ | score < 8/10 |

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `openai-provider.ts` –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç **–Ω–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ**, –∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π:

```
score = round((–ø–æ–ª—É—á–µ–Ω–æ–ó–∞–¥–∞–Ω–∏–π / –∑–∞–ø—Ä–æ—à–µ–Ω–æ–ó–∞–¥–∞–Ω–∏–π) * 10)
```

–£—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: `tasks.length < totalTasks * 0.8` (–ø–æ–ª—É—á–µ–Ω–æ –º–µ–Ω—å—à–µ 80% –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ).

| –ó–∞–ø—Ä–æ—à–µ–Ω–æ | –ü–æ–ª—É—á–µ–Ω–æ | Score | –ê–ª–µ—Ä—Ç? |
|---|---|---|---|
| 15 | 15 | -- | –ù–µ—Ç |
| 15 | 12 | -- | –ù–µ—Ç (>=80%) |
| 15 | 11 | 7 | –î–∞ |
| 10 | 6 | 6 | –î–∞ |
| 10 | 3 | 3 | –î–∞ |

### 5. –°—Ç–∞—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| –ú–µ—Å—Ç–æ | `server.ts`, callback `app.listen()` |
| –£—Ä–æ–≤–µ–Ω—å | `info` |
| Cooldown | –ù–µ—Ç (—Ä–∞–∑–æ–≤—ã–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ) |

–°–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Ä—Ç, –æ–∫—Ä—É–∂–µ–Ω–∏–µ (dev/prod) –∏ –≤—Ä–µ–º—è –ø–æ –ú–°–ö. –û–±—ë—Ä–Ω—É—Ç –≤ `.catch()` -- –Ω–µ –ª–æ–º–∞–µ—Ç –∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

### 6. –¢–µ—Å—Ç–æ–≤—ã–π –∞–ª–µ—Ä—Ç

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| –≠–Ω–¥–ø–æ–∏–Ω—Ç | `POST /api/admin/test-alert` |
| –£—Ä–æ–≤–µ–Ω—å | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π (default: `info`) |
| Rate limit | 5/–º–∏–Ω –Ω–∞ –∞–¥–º–∏–Ω–∞ |

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç–æ–≤—ã–π –∞–ª–µ—Ä—Ç" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/admin/settings`.

## –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ç–∞–π–º–∏–Ω–≥–æ–≤

| –ê–ª–µ—Ä—Ç | –£—Ä–æ–≤–µ–Ω—å | Cooldown | –ú–∏–Ω. –¥–∞–Ω–Ω—ã—Ö |
|---|---|---|---|
| –ü—Ä–æ–≤–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | critical | 0 (–∫–∞–∂–¥—ã–π) | -- |
| Error rate >10% | critical | 30 –º–∏–Ω | 5 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/—á–∞—Å |
| 3 —Ç–∞–π–º–∞—É—Ç–∞ –ø–æ–¥—Ä—è–¥ | critical | 30 –º–∏–Ω | 3 consecutive |
| –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (<8/10) | warning | 0 (–∫–∞–∂–¥—ã–π) | -- |
| –°—Ç–∞—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ | info | 0 (—Ä–∞–∑–æ–≤—ã–π) | -- |

## –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

–í—Å–µ –∞–ª–µ—Ä—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –≤ `sendAdminAlert()`:

```
{emoji} [{LEVEL}]

{—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è}
```

–≠–º–æ–¥–∑–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º:
- `info` -> ‚ÑπÔ∏è
- `warning` -> ‚ö†Ô∏è
- `critical` -> üö®

## API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è UI)

```
GET    /api/admin/settings            -- —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (chatId, wantsAlerts)
POST   /api/admin/settings/telegram   -- —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Chat ID { chatId: "123456" }
DELETE /api/admin/settings/telegram   -- –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```
POST /api/admin/test-alert                 -- –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∞–ª–µ—Ä—Ç
GET  /api/admin/alerts/metrics             -- —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (error rate, timeouts, cooldowns)
POST /api/admin/alerts/reset               -- —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
POST /api/admin/alerts/reset-cooldowns     -- —Å–±—Ä–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ cooldowns
POST /api/admin/alerts/test/error-rate     -- —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏
POST /api/admin/alerts/test/timeout        -- —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–π–º–∞—É—Ç—ã
POST /api/admin/alerts/test/low-quality    -- —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
```

## –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–í—Å—ë —Ç—Ä–µ–∫–∏–Ω–≥-—Å–æ—Å—Ç–æ—è–Ω–∏–µ **in-memory** (–Ω–µ –≤ –ë–î):
- `generationHistory[]` -- –º–∞—Å—Å–∏–≤ –¥–æ 1000 –∑–∞–ø–∏—Å–µ–π, –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ >1 —á–∞—Å
- `consecutiveTimeouts` -- —Å—á—ë—Ç—á–∏–∫, —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
- `lastErrorRateAlertTime` -- timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–ª–µ—Ä—Ç–∞ error rate
- `lastTimeoutAlertTime` -- timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–ª–µ—Ä—Ç–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω—É–ª—è–µ—Ç—Å—è.

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|---|---|
| `/subscribe` | –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∞–ª–µ—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) |
| `/unsubscribe` | –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç –∞–ª–µ—Ä—Ç–æ–≤ |
| `/status` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ |
| `/start`, `/help` | –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ |
