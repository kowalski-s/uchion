# AI Prompts & Generation Logic

## 1. Архитектура AI-слоя

Вся логика взаимодействия с ИИ изолирована в директории `api/_lib/ai/`.

### Компоненты:
1.  **`prompts.ts`**: Хранилище системных промптов для каждого предмета (`SUBJECT_CONFIG`).
2.  **`schema.ts`**: JSON-схемы для Structured Output (OpenAI).
3.  **`validator.ts`**: Логика проверки качества и регенерации.
4.  **`ai-provider.ts`**: Оркестратор процесса.

---

## 2. Промпты (`api/_lib/ai/prompts.ts`)

Мы используем специализированные системные промпты для каждого предмета.

### Русский язык (`RUSSIAN_SYSTEM_PROMPT`)
- **Роль**: Методист начальной школы (ФГОС).
- **Фокус**: Орфограммы, правила переноса, словарные слова.
- **Ограничения**: Запрет на темы 5+ класса, сложные термины.

### Математика (`MATH_SYSTEM_PROMPT`)
- **Роль**: Методист по математике.
- **Фокус**: Вычисления, текстовые задачи, геометрия.
- **Ограничения**: Соответствие числа и операций уровню класса (например, без отрицательных чисел в 1 классе).

---

## 3. Структура Ответа (Schema)

Модель обязана вернуть JSON, соответствующий `WORKSHEET_JSON_SCHEMA` (`api/_lib/ai/schema.ts`).

### Формат:
```json
{
  "assignments": [
    { "index": 1, "type": "apply", "text": "Текст задания..." },
    ... // Ровно 7 заданий
  ],
  "test": [
    { 
      "index": 1, 
      "question": "Вопрос?", 
      "options": { "A": "...", "B": "...", "C": "..." } 
    },
    ... // Ровно 10 вопросов
  ],
  "answers": {
    "assignments": ["Ответ 1", ...],
    "test": ["A", "C", ...]
  }
}
```

---

## 4. Валидация и Регенерация (`Validator`)

Мы не доверяем первому ответу модели. Каждый ответ проходит через `Validator` (LLM-based).

### Процесс:
1.  **Генерация**: Модель создает черновик.
2.  **Валидация**: `Validator` проверяет черновик по критериям:
    - Количество заданий (7) и тестов (10).
    - Соответствие теме и классу.
    - Корректность ответов.
    - Отсутствие "галлюцинаций".
3.  **Вердикт**:
    - `STATUS: OK` → Отдаем клиенту.
    - `STATUS: FAIL` + список `ISSUES` → Запускаем регенерацию.
4.  **Регенерация (Self-Correction)**:
    - Отправляем модели исходный JSON и список ошибок.
    - Модель возвращает **патч** (только исправленные блоки).
    - Патч применяется к исходному JSON.

---

## 5. Модели

- **Production**: `gpt-4o-mini` (оптимально по цене/качеству для структурированных задач).
- **Development**: `DummyProvider` (жестко закодированный ответ для тестов).

---

## 6. Context Retrieval (RAG)

При наличии `UCHION_VECTOR_STORE_ID`, провайдер пытается найти релевантные методические материалы в Vector Store OpenAI и добавить их в контекст генерации для повышения точности.
